<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>書籍介紹平台</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #7c3aed;
      --primary-dark: #5b21b6;
      --secondary: #f3e8ff;
      --accent: #a78bfa;
      --text: #222;
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Noto Sans TC', sans-serif;
      margin: 0;
      background: var(--secondary);
      color: var(--text);
    }
    header {
      background: var(--primary);
      color: #fff;
      padding: 1.5rem 2rem;
      text-align: center;
      border-radius: 0 0 var(--radius) var(--radius);
      box-shadow: 0 2px 8px rgba(124,58,237,0.07);
      position: relative;
    }
    nav {
      margin: 1.5rem 0;
      display: flex;
      justify-content: center;
      gap: 2rem;
    }
    nav a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 700;
      padding: 0.5rem 1rem;
      border-radius: var(--radius);
      transition: background 0.2s;
    }
    nav a:hover {
      background: var(--primary);
      color: #fff;
    }
    .container {
      max-width: 1000px;
      margin: 2rem auto;
      background: #fff;
      border-radius: var(--radius);
      box-shadow: 0 2px 16px rgba(124,58,237,0.08);
      padding: 2rem;
    }
    .book-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.5rem;
    }
    .book-card {
      background: var(--secondary);
      border-radius: var(--radius);
      padding: 1.2rem;
      box-shadow: 0 1px 6px rgba(124,58,237,0.05);
      transition: transform 0.15s;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    .book-card:hover {
      transform: translateY(-4px) scale(1.03);
      box-shadow: 0 4px 16px rgba(124,58,237,0.12);
    }
    .category {
      display: inline-block;
      background: var(--accent);
      color: #fff;
      border-radius: 8px;
      padding: 0.2rem 0.7rem;
      font-size: 0.95rem;
      margin-bottom: 0.5rem;
    }
    .login-modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(60,0,100,0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .login-box {
      background: #fff;
      border-radius: var(--radius);
      box-shadow: 0 2px 16px rgba(124,58,237,0.15);
      padding: 2rem 2.5rem;
      min-width: 320px;
      text-align: center;
    }
    .login-box input {
      width: 90%;
      margin: 0.7rem 0;
      padding: 0.6rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }
    .login-box button {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 0.7rem 2.2rem;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      margin-top: 1rem;
      transition: background 0.2s;
    }
    .login-box button:hover {
      background: var(--primary-dark);
    }
    .logout-btn {
      float: right;
      margin-top: -2.5rem;
      margin-right: 1rem;
      background: var(--primary-dark);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 0.4rem 1.2rem;
      font-size: 0.95rem;
      cursor: pointer;
    }
    .edit-btn {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 0.4rem 1.2rem;
      font-size: 0.95rem;
      cursor: pointer;
      margin-left: 0.5rem;
    }
    .comment-section {
      margin-top: 1.5rem;
      background: #f8f0ff;
      border-radius: 10px;
      padding: 1rem 1.5rem;
    }
    .comment-list {
      margin: 0.5rem 0 0 0;
      padding: 0;
      list-style: none;
    }
    .comment-list li {
      border-bottom: 1px solid #e0d7f7;
      padding: 0.5rem 0;
      font-size: 1rem;
    }
    .comment-list li:last-child { border-bottom: none; }
    .comment-form {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    .comment-form input {
      flex: 1;
      padding: 0.5rem;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .comment-form button {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.5rem 1.2rem;
      font-weight: 700;
      cursor: pointer;
    }
    .like-btn, .fav-btn {
      background: #fff;
      color: var(--primary-dark);
      border: 1.5px solid var(--primary-dark);
      border-radius: 6px;
      padding: 0.3rem 0.9rem;
      font-size: 1rem;
      font-weight: 700;
      margin-right: 0.5rem;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .like-btn.liked, .fav-btn.faved {
      background: var(--primary-dark);
      color: #fff;
    }
    .rank-board {
      background: #f8f0ff;
      border-radius: 12px;
      box-shadow: 0 1px 8px rgba(124,58,237,0.08);
      padding: 1.2rem 2rem;
      margin-bottom: 2rem;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    .rank-board h2 {
      margin-top: 0;
      color: var(--primary-dark);
      font-size: 1.3rem;
    }
    .rank-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .rank-list li {
      font-size: 1.1rem;
      margin: 0.5rem 0;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .rank-list .rank-num {
      font-weight: bold;
      color: var(--primary);
      font-size: 1.2rem;
      width: 2rem;
      display: inline-block;
    }
    @media (max-width: 700px) {
      .container { padding: 1rem; }
      .book-list { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <h1>書籍介紹平台</h1>
    <p>發現、分享與討論你喜愛的書籍</p>
    <button class="logout-btn" style="display:none" onclick="logout()">登出</button>
    <div id="user-menu" style="display:none; position:absolute; top:1.5rem; right:2rem;">
      <button id="user-btn" style="background:var(--primary-dark);color:#fff;border:none;border-radius:8px;padding:0.4rem 1.2rem;font-size:0.95rem;cursor:pointer;">
        <span id="user-name"></span> ▼
      </button>
      <div id="user-dropdown" style="display:none;position:absolute;right:0;top:2.2rem;background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(124,58,237,0.15);min-width:200px;z-index:2000;">
        <div style="padding:1rem;">
          <label style="font-size:0.95rem;">帳號</label>
          <input id="setting-user" type="text" style="width:100%;margin-bottom:0.5rem;padding:0.4rem;border-radius:6px;border:1px solid #ccc;" disabled>
          <label style="font-size:0.95rem;">新密碼</label>
          <input id="setting-pw" type="password" style="width:100%;margin-bottom:0.5rem;padding:0.4rem;border-radius:6px;border:1px solid #ccc;">
          <button onclick="saveUserSetting()" style="background:var(--primary);color:#fff;border:none;border-radius:6px;padding:0.4rem 1.2rem;font-weight:700;cursor:pointer;width:100%;">儲存</button>
          <div id="setting-msg" style="color:#b91c1c;margin-top:0.5rem;font-size:0.95rem;"></div>
          <hr style="margin:1rem 0;">
          <button onclick="showUserLikesFavs('like')" style="width:100%;margin-bottom:0.5rem;background:var(--accent);color:#fff;border:none;border-radius:6px;padding:0.4rem 0;font-weight:700;cursor:pointer;">我按讚的書</button>
          <button onclick="showUserLikesFavs('fav')" style="width:100%;background:var(--primary-dark);color:#fff;border:none;border-radius:6px;padding:0.4rem 0;font-weight:700;cursor:pointer;">我收藏的書</button>
          <div id="user-likes-favs" style="margin-top:0.7rem;"></div>
        </div>
      </div>
    </div>
  </header>
  <nav>
    <a href="#" onclick="showCategory('全部')">全部</a>
    <a href="#" onclick="showCategory('小說')">小說</a>
    <a href="#" onclick="showCategory('技術')">技術</a>
    <a href="#" onclick="showCategory('心理')">心理</a>
    <a href="#" onclick="showCategory('其他')">其他</a>
    <button class="edit-btn" style="display:none" onclick="editLayout()">編輯版面</button>
  </nav>
  <div class="container">
    <div class="rank-board" id="rank-board" style="display:none"></div>
    <div id="book-list" class="book-list"></div>
  </div>
  <!-- 登入/註冊視窗 -->
  <div class="login-modal" id="login-modal">
    <div class="login-box">
      <h2 id="login-title">版主登入</h2>
      <input type="text" id="login-user" placeholder="帳號">
      <input type="password" id="login-pw" placeholder="密碼">
      <button id="login-btn" onclick="login()">登入</button>
      <button id="switch-btn" style="margin-left:1rem;" onclick="switchMode()">註冊</button>
      <div id="login-msg" style="color:#b91c1c;margin-top:0.5rem;"></div>
    </div>
  </div>
  <script>
    // 書籍資料（增加 likeCount）
    let books = [
      { id:1, title:'解憂雜貨店', author:'東野圭吾', category:'小說', desc:'一間神祕的雜貨店，解答人們的煩惱。', comments:[], likeCount:0 },
      { id:2, title:'JavaScript 實戰', author:'王小明', category:'技術', desc:'從入門到進階，帶你掌握 JS 核心。', comments:[], likeCount:0 },
      { id:3, title:'被討厭的勇氣', author:'岸見一郎', category:'心理', desc:'阿德勒心理學經典，改變人生的勇氣。', comments:[], likeCount:0 },
      { id:4, title:'自訂書籍', author:'自訂作者', category:'其他', desc:'你可以在編輯模式新增/修改書籍。', comments:[], likeCount:0 }
    ];
    // 儲存留言到 localStorage
    function saveComments() {
      localStorage.setItem('bookComments', JSON.stringify(books.map(b=>b.comments)));
    }
    // 載入留言
    function loadComments() {
      let c = localStorage.getItem('bookComments');
      if(c) {
        let arr = JSON.parse(c);
        books.forEach((b,i)=>{ b.comments = arr[i]||[]; });
      }
    }
    // 儲存書籍按讚數（根據所有帳號計算）
    function recalcBookLikes() {
      let db = getDatabase();
      books.forEach(b => b.likeCount = 0);
      Object.values(db).forEach(userData => {
        (userData.like||[]).forEach(id => {
          let book = books.find(b=>b.id===id);
          if(book) book.likeCount++;
        });
      });
      localStorage.setItem('bookLikes', JSON.stringify(books.map(b=>b.likeCount)));
    }
    function loadBookLikes() {
      recalcBookLikes(); // always recalc from db
    }
    // 使用者資料庫（儲存所有帳號的like/fav）
    function getDatabase() {
      let db = localStorage.getItem('userDatabase');
      if(db) return JSON.parse(db);
      return {};
    }
    function setDatabase(db) {
      localStorage.setItem('userDatabase', JSON.stringify(db));
    }
    function getUserData() {
      const user = localStorage.getItem('currentUser');
      if(!user) return {like:[], fav:[]};
      let db = getDatabase();
      if(db[user]) return db[user];
      return {like:[], fav:[]};
    }
    function setUserData(data) {
      const user = localStorage.getItem('currentUser');
      if(!user) return;
      let db = getDatabase();
      db[user] = data;
      setDatabase(db);
    }
    // 按讚
    function likeBook(id) {
      const user = localStorage.getItem('currentUser');
      if(!user) return;
      let data = getUserData();
      if(!data.like.includes(id)) {
        data.like.push(id);
        setUserData(data);
        recalcBookLikes();
        renderBooks();
        renderRank();
      }
    }
    // 收藏
    function favBook(id) {
      const user = localStorage.getItem('currentUser');
      if(!user) return;
      let data = getUserData();
      if(!data.fav.includes(id)) {
        data.fav.push(id);
        setUserData(data);
        renderBooks();
      }
    }
    // 取消讚/收藏
    function unlikeBook(id) {
      const user = localStorage.getItem('currentUser');
      if(!user) return;
      let data = getUserData();
      let idx = data.like.indexOf(id);
      if(idx>-1) {
        data.like.splice(idx,1);
        setUserData(data);
        recalcBookLikes();
        renderBooks();
        renderRank();
      }
    }
    function unfavBook(id) {
      const user = localStorage.getItem('currentUser');
      if(!user) return;
      let data = getUserData();
      let idx = data.fav.indexOf(id);
      if(idx>-1) {
        data.fav.splice(idx,1);
        setUserData(data);
        renderBooks();
      }
    }
    // 顯示排行榜
    function renderRank() {
      loadBookLikes();
      let sorted = [...books].sort((a,b)=>b.likeCount-a.likeCount).slice(0,3);
      let html = `<h2>排行榜（按讚數）</h2><ul class="rank-list">`;
      sorted.forEach((b,i)=>{
        html += `<li><span class="rank-num">${i+1}</span> ${b.title} <span style='color:#7c3aed'>(讚：${b.likeCount})</span></li>`;
      });
      html += '</ul>';
      document.getElementById('rank-board').innerHTML = html;
      document.getElementById('rank-board').style.display = 'block';
    }
    // 顯示個人讚/收藏（修正版，點擊時即時刷新，且可多次切換正確顯示）
    function showUserLikesFavs(type) {
      let data = getUserData();
      let arr = type==='like' ? data.like : data.fav;
      let html = `<div style='margin-top:0.5rem;'><b>${type==='like'?'我按讚的書':'我收藏的書'}</b><ul style='padding-left:1.2em;'>`;
      if(arr.length===0) html += '<li>尚無資料</li>';
      else arr.forEach(id=>{
        let b = books.find(b=>String(b.id)===String(id));
        if(b) html += `<li>${b.title}</li>`;
      });
      html += '</ul></div>';
      // 先清空再插入，避免多次點擊內容疊加
      const container = document.getElementById('user-likes-favs');
      container.innerHTML = '';
      container.insertAdjacentHTML('beforeend', html);
    }
    // 書籍列表顯示按鈕
    function renderBooks(category='全部') {
      loadComments();
      loadBookLikes();
      let list = document.getElementById('book-list');
      let show = category==='全部' ? books : books.filter(b=>b.category===category);
      // 取得最新的 userData（避免快取）
      const user = localStorage.getItem('currentUser');
      let data = {like:[], fav:[]};
      if(user) {
        let db = getDatabase();
        if(db[user]) data = db[user];
      }
      list.innerHTML = show.map(b=>{
        let liked = data.like.includes(b.id);
        let faved = data.fav.includes(b.id);
        return `<div class="book-card">
          <span class="category">${b.category}</span>
          <h3>${b.title}</h3>
          <div style="color:#7c3aed;font-size:1.05rem;">作者：${b.author}</div>
          <p>${b.desc}</p>
          <div style='margin-bottom:0.7rem;'>
            <button class="like-btn${liked?' liked':''}" onclick="${liked?'unlikeBook':'likeBook'}(${b.id})">${liked?'已按讚':'按讚'} (${b.likeCount})</button>
            <button class="fav-btn${faved?' faved':''}" onclick="${faved?'unfavBook':'favBook'}(${b.id})">${faved?'已收藏':'收藏'}</button>
          </div>
          <div class="comment-section">
            <strong>留言區</strong>
            <ul class="comment-list" id="comments-${b.id}">
              ${(b.comments||[]).map(c=>`<li>${c}</li>`).join('')}
            </ul>
            <form class="comment-form" onsubmit="addComment(event,${b.id})">
              <input type="text" placeholder="寫下你的想法..." required>
              <button type="submit">留言</button>
            </form>
          </div>
        </div>`;
      }).join('');
    }
    // 切換分類
    function showCategory(cat) {
      renderBooks(cat);
    }
    // 新增留言
    function addComment(e, id) {
      e.preventDefault();
      let input = e.target.querySelector('input');
      let val = input.value.trim();
      if(val) {
        let book = books.find(b=>b.id===id);
        book.comments = book.comments || [];
        book.comments.push(val);
        saveComments();
        renderBooks();
      }
      input.value = '';
    }
    // 註冊/登入模式切換
    let isRegister = false;
    function switchMode() {
      isRegister = !isRegister;
      document.getElementById('login-title').innerText = isRegister ? '註冊新帳號' : '版主登入';
      document.getElementById('login-btn').innerText = isRegister ? '註冊' : '登入';
      document.getElementById('switch-btn').innerText = isRegister ? '返回登入' : '註冊';
      document.getElementById('login-msg').innerText = '';
    }
    // 註冊功能
    function register() {
      let user = document.getElementById('login-user').value;
      let pw = document.getElementById('login-pw').value;
      if(!user || !pw) {
        document.getElementById('login-msg').innerText = '請輸入帳號與密碼';
        return;
      }
      if(localStorage.getItem('user_'+user)) {
        document.getElementById('login-msg').innerText = '帳號已存在';
        return;
      }
      localStorage.setItem('user_'+user, pw);
      document.getElementById('login-msg').innerText = '註冊成功，請登入';
      switchMode();
    }
    // 修改登入按鈕行為
    function resetSessionUI() {
      // 隱藏所有需要登入狀態的UI
      document.querySelector('.logout-btn').style.display = 'none';
      document.querySelector('.edit-btn').style.display = 'none';
      document.getElementById('user-menu').style.display = 'none';
      // 重設書本列表UI
      renderBooks();
      renderRank();
    }
    function login() {
      let user = document.getElementById('login-user').value;
      let pw = document.getElementById('login-pw').value;
      if(isRegister) {
        register();
        return;
      }
      // 內建版主帳號
      if(user==='0315' && pw==='0315') {
        localStorage.setItem('isAdmin','1');
        localStorage.setItem('currentUser', user);
        document.getElementById('login-modal').style.display='none';
        document.querySelector('.logout-btn').style.display='inline-block';
        document.querySelector('.edit-btn').style.display='inline-block';
        showUserMenu();
        renderBooks();
        renderRank();
      } else if(localStorage.getItem('user_'+user) === pw) {
        localStorage.setItem('isAdmin','0');
        localStorage.setItem('currentUser', user);
        document.getElementById('login-modal').style.display='none';
        document.querySelector('.logout-btn').style.display='inline-block';
        document.querySelector('.edit-btn').style.display='none';
        showUserMenu();
        renderBooks();
        renderRank();
      } else {
        document.getElementById('login-msg').innerText = '帳號或密碼錯誤';
      }
    }
    function logout() {
      localStorage.removeItem('isAdmin');
      localStorage.removeItem('currentUser');
      document.getElementById('login-modal').style.display='flex';
      resetSessionUI();
    }
    // 版主編輯模式（可擴充：新增/刪除/編輯書籍、調整版面）
    function editLayout() {
      alert('這裡可擴充為版主專屬的版面編輯功能！');
    }
    // 顯示右上帳號
    function showUserMenu() {
      const user = localStorage.getItem('currentUser');
      if(user) {
        document.getElementById('user-menu').style.display = 'block';
        document.getElementById('user-name').innerText = user;
        document.getElementById('setting-user').value = user;
      } else {
        document.getElementById('user-menu').style.display = 'none';
      }
    }
    // 點擊帳號展開/收合設定選單（再次修正，確保每次展開都清空收藏/按讚區塊）
    document.addEventListener('DOMContentLoaded', function() {
      const userBtn = document.getElementById('user-btn');
      const userDropdown = document.getElementById('user-dropdown');
      if(userBtn) {
        userBtn.onclick = function(e) {
          e.stopPropagation();
          if(userDropdown.style.display === 'block') {
            userDropdown.style.display = 'none';
          } else {
            userDropdown.style.display = 'block';
            document.getElementById('user-likes-favs').innerHTML = '';
          }
        };
      }
      if(userDropdown) {
        userDropdown.onclick = function(e) { e.stopPropagation(); };
      }
      document.body.onclick = function() {
        if(userDropdown) userDropdown.style.display = 'none';
      };
    });
    // 儲存帳密設定（修正版，立即反映）
    function saveUserSetting() {
      const user = localStorage.getItem('currentUser');
      const newPw = document.getElementById('setting-pw').value;
      if(!newPw) {
        document.getElementById('setting-msg').innerText = '請輸入新密碼';
        return;
      }
      if(user === '0315') {
        document.getElementById('setting-msg').innerText = '內建版主帳號無法變更密碼';
        return;
      }
      localStorage.setItem('user_' + user, newPw);
      document.getElementById('setting-msg').innerText = '密碼已更新';
      document.getElementById('setting-pw').value = '';
    }
    // 自動登入狀態
    window.onload = function() {
      loadComments();
      loadBookLikes();
      renderBooks();
      renderRank();
      if(localStorage.getItem('currentUser')) {
        document.getElementById('login-modal').style.display='none';
        document.querySelector('.logout-btn').style.display='inline-block';
        if(localStorage.getItem('isAdmin')==='1') {
          document.querySelector('.edit-btn').style.display='inline-block';
        } else {
          document.querySelector('.edit-btn').style.display='none';
        }
        showUserMenu();
      } else {
        resetSessionUI();
      }
    }
  </script>
</body>
</html>
